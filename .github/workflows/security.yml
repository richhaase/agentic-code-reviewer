name: Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Run govulncheck
      run: |
        echo "Checking for vulnerabilities in dependencies..."
        go run golang.org/x/vuln/cmd/govulncheck@latest ./...

    - name: Run gosec
      run: |
        echo "Running security analysis..."
        # Exclusions kept in sync with .golangci.yml (source of truth):
        # G104: Audit errors not checked - handled by errcheck
        # G204: Subprocess execution (needed for codex/claude/gemini/gh CLIs)
        # G301: Directory permissions - we use standard 0755 for config dirs
        # G302: File permissions - we use standard 0644 for readable config files
        # G304: File path input (needed for config file reading)
        # G306: WriteFile permissions - we use 0644 for config files intentionally
        # G404: Weak random number generator - used for non-security test data
        go run github.com/securego/gosec/v2/cmd/gosec@latest -exclude=G104,G204,G301,G302,G304,G306,G404 ./...
      continue-on-error: ${{ github.event_name == 'schedule' }}

    - name: Summary
      if: always()
      run: echo "Security checks completed. Review any findings above."
