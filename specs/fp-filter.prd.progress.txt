# Deterministic FP Filter - Progress Log

## Project Context
- Codebase: ACR (Agentic Code Reviewer) - Go CLI for parallel LLM code reviews
- Current FP filter location: internal/fpfilter/
- Build command: make build
- Test command: make test
- Lint command: make check

## Learnings
(Entries will be added by Ralph as work progresses)

---

## Iteration 1 - Story 1: Define in-place evaluation data structures

**Why this story was selected:**
- Foundation story with ZERO dependencies
- Blocks Stories 2, 3, and 5 - all depend on these new data structures
- Low risk - purely structural changes (adding types, no behavioral changes)
- Following the principle of "foundation first" to unblock parallel work in future iterations

**What was implemented:**
1. Added `FindingEvaluation` struct with:
   - Core fields: ID, Title, Summary, Messages, ReviewerCount
   - Nullable evaluation fields: IsFalsePositive (*bool), Reasoning (*string)
   - These use pointers to support null/filled distinction in JSON
2. Added `EvaluationPayload` wrapper struct containing []FindingEvaluation
3. Added `FilteredFinding` struct with Finding and Reasoning fields
4. Updated `Result` struct with new field names:
   - Grouped → Kept (more descriptive of what's kept after filtering)
   - Removed → Filtered (consistent terminology)
   - RemovedCount → FilteredCount
   - EvalErrors → ParseErrors (more accurate description)
5. Updated `Apply()` function in filter.go to use new field names
6. Updated review.go to reference new Result field names (Kept, FilteredCount)
7. Kept old `EvaluatedFinding` struct marked as deprecated for backward compatibility during transition

**Gotchas and patterns discovered:**
- Using pointer types (*bool, *string) is the Go idiom for nullable JSON fields
- The `omitempty` JSON tag allows fields to be omitted when null (important for the in-place pattern)
- Changed field names cascade through Apply() function and its call site in review.go
- Go's type system caught all field rename issues at compile time
- Existing tests still pass because they don't directly inspect Result fields

**Files modified:**
- internal/fpfilter/filter.go (new structs, Apply() updates)
- cmd/acr/review.go (Result field name updates)

**What stories are now unblocked:**
- Story 2: Can now reference FindingEvaluation in the new prompt
- Story 3: Can now use EvaluationPayload and parse into FindingEvaluation
- Story 5: Can now use the new Result structure with Kept/Filtered fields

---

## Iteration 2 - Story 2: Update FP filter prompt for boolean output

**Why this story was selected:**
- Story 1 (data structures) is complete, so Story 2 is now unblocked
- Story 3 (filter logic) depends on Story 2 - the logic needs the prompt to guide agent behavior correctly
- Lower risk than Story 3 - just prompt text changes, no complex parsing logic
- Foundation piece that defines the agent contract for the in-place evaluation pattern
- Stories 4, 5, 6 are all independent but less impactful until the core logic (Story 3) is updated

**What was implemented:**
1. Completely rewrote the fpEvaluationPrompt constant to use boolean classification:
   - Removed all references to fp_score (0-100 numeric scale)
   - Added is_false_positive (boolean) and reasoning (string) fields to input format docs
   - Updated decision criteria sections: "FALSE POSITIVE" and "TRUE POSITIVE" instead of score ranges
   - Updated "WHEN UNCERTAIN" guidance to bias toward keeping findings (is_false_positive: false)
2. Updated all 6 examples to show the in-place update pattern:
   - Input shows fields with null values for is_false_positive and reasoning
   - Output shows same structure with those fields filled in
   - Demonstrates the JSON roundtrip the agent is expected to perform
3. Updated output format section:
   - Changed from {"evaluations": [...]} to {"findings": [...]}
   - Matches the EvaluationPayload struct from Story 1
   - Shows complete finding object in output, not just ID + score
4. Updated reviewer_count guidance:
   - High count → "Set is_false_positive: false" (instead of "bias toward lower fp_score")
   - Clearer decision guidance for boolean classification
5. Removed all threshold-related language from rules section

**Gotchas and patterns discovered:**
- The prompt needs to be VERY explicit about the in-place pattern (same structure in/out)
- Including concrete input/output examples prevents agent confusion about expected format
- Boolean decision is clearer than numeric scoring - reduces agent uncertainty
- Keeping reviewer_count guidance helps agent make better decisions even without threshold
- Conservative default (uncertain → keep finding) is safer than filtering questionable issues

**Files modified:**
- internal/fpfilter/prompt.go (complete prompt rewrite)

**What stories are now unblocked:**
- Story 3: Can now implement the filter logic knowing the exact agent contract

---
